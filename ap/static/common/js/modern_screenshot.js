(function(g,C){typeof exports=="object"&&typeof module!="undefined"?C(exports):typeof define=="function"&&define.amd?define(["exports"],C):(g=typeof globalThis!="undefined"?globalThis:g||self,C(g.modernScreenshot={}))})(this,function(g){var Fe;"use strict";var zt=Object.defineProperty,Xt=Object.defineProperties;var Gt=Object.getOwnPropertyDescriptors;var Q=Object.getOwnPropertySymbols;var Ue=Object.prototype.hasOwnProperty,_e=Object.prototype.propertyIsEnumerable;var $e=Math.pow,Pe=(g,C,T)=>C in g?zt(g,C,{enumerable:!0,configurable:!0,writable:!0,value:T}):g[C]=T,x=(g,C)=>{for(var T in C||(C={}))Ue.call(C,T)&&Pe(g,T,C[T]);if(Q)for(var T of Q(C))_e.call(C,T)&&Pe(g,T,C[T]);return g},M=(g,C)=>Xt(g,Gt(C));var Be=(g,C)=>{var T={};for(var N in g)Ue.call(g,N)&&C.indexOf(N)<0&&(T[N]=g[N]);if(g!=null&&Q)for(var N of Q(g))C.indexOf(N)<0&&_e.call(g,N)&&(T[N]=g[N]);return T};var S=(g,C,T)=>new Promise((N,O)=>{var V=D=>{try{j(T.next(D))}catch(q){O(q)}},W=D=>{try{j(T.throw(D))}catch(q){O(q)}},j=D=>D.done?N(D.value):Promise.resolve(D.value).then(V,W);j((T=T.apply(g,C)).next())});function C(e,t){return e[13]=1,e[14]=t>>8,e[15]=t&255,e[16]=t>>8,e[17]=t&255,e}const T="p".charCodeAt(0),N="H".charCodeAt(0),O="Y".charCodeAt(0),V="s".charCodeAt(0);let W;function j(){const e=new Int32Array(256);for(let t=0;t<256;t++){let n=t;for(let r=0;r<8;r++)n=n&1?3988292384^n>>>1:n>>>1;e[t]=n}return e}function D(e){let t=-1;W||(W=j());for(let n=0;n<e.length;n++)t=W[(t^e[n])&255]^t>>>8;return t^-1}function q(e){const t=e.length-1;for(let n=t;n>=4;n--)if(e[n-4]===9&&e[n-3]===T&&e[n-2]===N&&e[n-1]===O&&e[n]===V)return n-3;return 0}function re(e,t,n=!1){const r=new Uint8Array(13);t*=39.3701,r[0]=T,r[1]=N,r[2]=O,r[3]=V,r[4]=t>>>24,r[5]=t>>>16,r[6]=t>>>8,r[7]=t&255,r[8]=r[4],r[9]=r[5],r[10]=r[6],r[11]=r[7],r[12]=1;const a=D(r),s=new Uint8Array(4);if(s[0]=a>>>24,s[1]=a>>>16,s[2]=a>>>8,s[3]=a&255,n){const o=q(e);return e.set(r,o),e.set(s,o+13),e}else{const o=new Uint8Array(4);o[0]=0,o[1]=0,o[2]=0,o[3]=9;const c=new Uint8Array(54);return c.set(e,0),c.set(o,33),c.set(r,37),c.set(s,50),c}}const Le="AAlwSFlz",Me="AAAJcEhZ",Oe="AAAACXBI";function We(e){let t=e.indexOf(Le);return t===-1&&(t=e.indexOf(Me)),t===-1&&(t=e.indexOf(Oe)),t}const Z="[modern-screenshot]",F=typeof window!="undefined",je=F&&"Worker"in window,oe=F&&"atob"in window,qe=F&&"btoa"in window,ee=F?(Fe=window.navigator)==null?void 0:Fe.userAgent:"",ae=ee.includes("Chrome"),H=ee.includes("AppleWebKit")&&!ae,se=ee.includes("Firefox"),Ve=e=>e&&"__CONTEXT__"in e,He=e=>e.constructor.name==="CSSFontFaceRule",ze=e=>e.constructor.name==="CSSImportRule",I=e=>e.nodeType===1,R=e=>typeof e.className=="object",Xe=e=>R(e)&&e.tagName==="svg",ie=e=>R(e)&&e.tagName==="image",te=e=>I(e)&&typeof e.style!="undefined"&&!R(e),Ge=e=>e.nodeType===8,Ye=e=>e.nodeType===3,U=e=>e.tagName==="IMG",z=e=>e.tagName==="VIDEO",Je=e=>e.tagName==="CANVAS",ce=e=>e.tagName==="TEXTAREA",Ke=e=>e.tagName==="INPUT",Qe=e=>e.tagName==="STYLE",Ze=e=>e.tagName==="SCRIPT",et=e=>e.tagName==="SELECT",tt=e=>e.tagName==="SLOT",nt=e=>e.tagName==="IFRAME",v=(...e)=>console.warn(Z,...e),rt=e=>console.time(`${Z} ${e}`),ot=e=>console.timeEnd(`${Z} ${e}`),at=e=>{var n;const t=(n=e==null?void 0:e.createElement)==null?void 0:n.call(e,"canvas");return t&&(t.height=t.width=1),t&&"toDataURL"in t&&Boolean(t.toDataURL("image/webp").includes("image/webp"))},ne=e=>e.startsWith("data:");function le(e,t){if(e.match(/^[a-z]+:\/\//i))return e;if(F&&e.match(/^\/\//))return window.location.protocol+e;if(e.match(/^[a-z]+:/i)||!F)return e;const n=X().implementation.createHTMLDocument(),r=n.createElement("base"),a=n.createElement("a");return n.head.appendChild(r),n.body.appendChild(a),t&&(r.href=t),a.href=e,a.href}function X(e){var t;return(t=e&&I(e)?e==null?void 0:e.ownerDocument:e)!=null?t:window.document}const G="http://www.w3.org/2000/svg";function ue(e,t,n){const r=X(n).createElementNS(G,"svg");return r.setAttributeNS(null,"width",e.toString()),r.setAttributeNS(null,"height",t.toString()),r.setAttributeNS(null,"viewBox",`0 0 ${e} ${t}`),r}function fe(e){const t=new XMLSerializer().serializeToString(e).replace(/[\u0000-\u0008\u000B\u000C\u000E-\u001F\uD800-\uDFFF\uFFFE\uFFFF]/ug,"");return`data:image/svg+xml;charset=utf-8,${encodeURIComponent(t)}`}function st(e,t="image/png",n=1){return S(this,null,function*(){try{return yield new Promise((r,a)=>{e.toBlob(s=>{s?r(s):a(new Error("Blob is null"))},t,n)})}catch(r){if(oe)return v("Failed canvas to blob",{type:t,quality:n},r),it(e.toDataURL(t,n));throw r}})}function it(e){var c,i;const[t,n]=e.split(","),r=(i=(c=t.match(/data:(.+);/))==null?void 0:c[1])!=null?i:void 0,a=window.atob(n),s=a.length,o=new Uint8Array(s);for(let u=0;u<s;u+=1)o[u]=a.charCodeAt(u);return new Blob([o],{type:r})}function de(e,t){return new Promise((n,r)=>{const a=new FileReader;a.onload=()=>n(a.result),a.onerror=()=>r(a.error),a.onabort=()=>r(new Error(`Failed read blob to ${t}`)),t==="dataUrl"?a.readAsDataURL(e):t==="arrayBuffer"&&a.readAsArrayBuffer(e)})}const ct=e=>de(e,"dataUrl"),lt=e=>de(e,"arrayBuffer");function P(e,t){const n=X(t).createElement("img");return n.decoding="sync",n.loading="eager",n.src=e,n}function _(e,t){return new Promise(n=>{const{timeout:r,ownerDocument:a,onError:s}=t!=null?t:{},o=typeof e=="string"?P(e,X(a)):e;let c=null,i=null;function u(){n(o),c&&clearTimeout(c),i==null||i()}if(r&&(c=setTimeout(u,r)),z(o)){const l=o.currentSrc||o.src;if(!l)return o.poster?_(o.poster,t).then(n):u();if(o.readyState>=2)return u();const f=u,d=m=>{v("Failed video load",l,m),s==null||s(m),u()};i=()=>{o.removeEventListener("loadeddata",f),o.removeEventListener("error",d)},o.addEventListener("loadeddata",f,{once:!0}),o.addEventListener("error",d,{once:!0})}else{const l=ie(o)?o.href.baseVal:o.currentSrc||o.src;if(!l)return u();const f=()=>S(this,null,function*(){if(U(o)&&"decode"in o)try{yield o.decode()}catch(m){v("Failed to decode image, trying to render anyway",o.dataset.originalSrc||l,m)}u()}),d=m=>{v("Failed image load",o.dataset.originalSrc||l,m),u()};if(U(o)&&o.complete)return f();i=()=>{o.removeEventListener("load",f),o.removeEventListener("error",d)},o.addEventListener("load",f,{once:!0}),o.addEventListener("error",d,{once:!0})}})}function me(e,t){return S(this,null,function*(){te(e)&&(U(e)||z(e)?yield _(e,{timeout:t}):yield Promise.all(["img","video"].flatMap(n=>Array.from(e.querySelectorAll(n)).map(r=>_(r,{timeout:t})))))})}const ge=function(){let t=0;const n=()=>`0000${(Math.random()*$e(36,4)<<0).toString(36)}`.slice(-4);return()=>(t+=1,`u${n()}${t}`)}();function ut(e){return{time:t=>e&&rt(t),timeEnd:t=>e&&ot(t),warn:(...t)=>e&&v(...t)}}function ft(e){return{cache:e?"no-cache":"force-cache"}}function k(e,t){return S(this,null,function*(){return Ve(e)?e:he(e,M(x({},t),{autoDestruct:!0}))})}function he(e,t){return S(this,null,function*(){var d,m,w,y;const{scale:n=1,workerUrl:r,workerNumber:a=1}=t||{},s=Boolean(t==null?void 0:t.debug),o=(d=e.ownerDocument)!=null?d:F?window.document:void 0,c=(w=(m=e.ownerDocument)==null?void 0:m.defaultView)!=null?w:F?window:void 0,i=new Map,u=M(x({width:0,height:0,quality:1,type:"image/png",scale:n,backgroundColor:null,style:null,filter:null,maximumCanvasSize:0,timeout:3e4,progress:null,debug:s,fetch:x({requestInit:ft((y=t==null?void 0:t.fetch)==null?void 0:y.bypassingCache),placeholderImage:"data:image/png;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",bypassingCache:!1},t==null?void 0:t.fetch),font:{},drawImageInterval:100,workerUrl:null,workerNumber:a,onCloneNode:null,onEmbedNode:null,onCreateForeignObjectSvg:null,autoDestruct:!1},t),{__CONTEXT__:!0,log:ut(s),node:e,ownerDocument:o,ownerWindow:c,dpi:n===1?null:96*n,svgStyleElement:we(o),svgDefsElement:o==null?void 0:o.createElementNS(G,"defs"),svgStyles:new Map,defaultComputedStyles:new Map,workers:[...new Array(je&&r&&a?a:0)].map(()=>{try{const b=new Worker(r);return b.onmessage=h=>S(this,null,function*(){var A,B,L,Re;const{url:E,result:p}=h.data;p?(B=(A=i.get(E))==null?void 0:A.resovle)==null||B.call(A,p):(Re=(L=i.get(E))==null?void 0:L.reject)==null||Re.call(L,new Error(`Error receiving message from worker: ${E}`))}),b.onmessageerror=h=>{var p,A;const{url:E}=h.data;(A=(p=i.get(E))==null?void 0:p.reject)==null||A.call(p,new Error(`Error receiving message from worker: ${E}`))},b}catch(b){return v("Failed to new Worker",b),null}}).filter(Boolean),fontFamilies:new Set,fontCssTexts:new Map,acceptOfImage:`${[at(o)&&"image/webp","image/svg+xml","image/*","*/*"].filter(Boolean).join(",")};q=0.8`,requests:i,drawImageCount:0,tasks:[]});u.log.time("wait until load"),yield me(e,u.timeout),u.log.timeEnd("wait until load");const{width:l,height:f}=dt(e,u);return u.width=l,u.height=f,u})}function we(e){if(!e)return;const t=e.createElement("style"),n=t.ownerDocument.createTextNode(`
.______background-clip--text {
  background-clip: text;
  -webkit-background-clip: text;
}
`);return t.appendChild(n),t}function dt(e,t){let{width:n,height:r}=t;if(I(e)&&(!n||!r)){const a=e.getBoundingClientRect();n=n||a.width||Number(e.getAttribute("width"))||0,r=r||a.height||Number(e.getAttribute("height"))||0}return{width:n,height:r}}function mt(e,t){return S(this,null,function*(){const{log:n,timeout:r,drawImageCount:a,drawImageInterval:s}=t;n.time("image to canvas");const o=yield _(e,{timeout:r}),{canvas:c,context2d:i}=gt(e.ownerDocument,t),u=()=>{try{i==null||i.drawImage(o,0,0,c.width,c.height)}catch(l){v("Failed to drawImage",l)}};u();for(let l=0;l<a;l++)yield new Promise(f=>{setTimeout(()=>{u(),f()},l+s)});return t.drawImageCount=0,n.timeEnd("image to canvas"),c})}function gt(e,t){const{width:n,height:r,scale:a,backgroundColor:s,maximumCanvasSize:o}=t,c=e.createElement("canvas");c.width=Math.floor(n*a),c.height=Math.floor(r*a),c.style.width=`${n}px`,c.style.height=`${r}px`,o&&(c.width>o||c.height>o)&&(c.width>o&&c.height>o?c.width>c.height?(c.height*=o/c.width,c.width=o):(c.width*=o/c.height,c.height=o):c.width>o?(c.height*=o/c.width,c.width=o):(c.width*=o/c.height,c.height=o));const i=c.getContext("2d");return i&&s&&(i.fillStyle=s,i.fillRect(0,0,c.width,c.height)),{canvas:c,context2d:i}}const ht=["width","height"],wt=["stroke","fill"];function pe(e,t,n){var b;const{defaultComputedStyles:r,ownerDocument:a}=n,s=e.nodeName.toLowerCase(),o=R(e)&&s!=="svg",c=o?wt.map(h=>[h,e.getAttribute(h)]).filter(([,h])=>h!==null):[],i=[o&&"svg",s,c.map((h,E)=>`${h}=${E}`).join(","),t].filter(Boolean).join(":");if(r.has(i))return r.get(i);let u=n.sandbox;if(!u)try{a&&(u=a.createElement("iframe"),u.id=`__SANDBOX__-${ge()}`,u.width="0",u.height="0",u.style.visibility="hidden",u.style.position="fixed",a.body.appendChild(u),(b=u.contentWindow)==null||b.document.write('<!DOCTYPE html><meta charset="UTF-8"><title></title><body>'),n.sandbox=u)}catch(h){v("Failed to create iframe sandbox",h)}if(!u)return new Map;const l=u.contentWindow;if(!l)return new Map;const f=l.document;let d,m;o?(d=f.createElementNS(G,"svg"),m=d.ownerDocument.createElementNS(d.namespaceURI,s),c.forEach(([h,E])=>{m.setAttributeNS(null,h,E)}),d.appendChild(m)):d=m=f.createElement(s),m.textContent=" ",f.body.appendChild(d);const w=l.getComputedStyle(m,t),y=new Map;for(let h=w.length,E=0;E<h;E++){const p=w.item(E);ht.includes(p)||y.set(p,w.getPropertyValue(p))}return f.body.removeChild(d),r.set(i,y),y}function ye(e,t){var s;const n=new Map,r=[],a=new Map;for(let o=e.length,c=0;c<o;c++){const i=e.item(c),u=e.getPropertyValue(i),l=e.getPropertyPriority(i),f=i.lastIndexOf("-"),d=f>-1?i.substring(0,f):void 0;if(d){let m=a.get(d);m||(m=new Map,a.set(d,m)),m.set(i,[u,l])}t.get(i)===u&&!l||(d?r.push(d):n.set(i,[u,l]))}for(let o=r.length,c=0;c<o;c++)(s=a.get(r[c]))==null||s.forEach((i,u)=>n.set(u,i));return n}const pt=[":before",":after"],yt=[":-webkit-scrollbar",":-webkit-scrollbar-button",":-webkit-scrollbar-thumb",":-webkit-scrollbar-track",":-webkit-scrollbar-track-piece",":-webkit-scrollbar-corner",":-webkit-resizer"];function bt(e,t,n,r){const{ownerWindow:a,svgStyleElement:s,svgStyles:o}=r;if(!s||!a)return;function c(i){var h;const u=a.getComputedStyle(e,i);let l=u.getPropertyValue("content");if(!l||l==="none")return;l=l.replace(/(')|(")|(counter\(.+\))/g,"");const f=[ge()],d=pe(e,i,r),m=[`content: '${l}';`],w=ye(u,d);if(w.delete("content"),w.delete("-webkit-locale"),((h=w.get("background-clip"))==null?void 0:h[0])==="text"&&t.classList.add("______background-clip--text"),w.forEach(([E,p],A)=>{m.push(`${A}: ${E}${p?" !important":""};`)}),m.length===1)return;try{t.className=[t.className,...f].join(" ")}catch(E){return}const y=m.join(`
  `);let b=o.get(y);b||(b=[],o.set(y,b)),b.push(`.${f[0]}:${i}`)}pt.forEach(c),n&&yt.forEach(c)}function St(e,t){ce(e)&&(t.innerHTML=e.value),(ce(e)||Ke(e)||et(e))&&t.setAttribute("value",e.value)}function Et(e,t,n,r){var u,l,f,d;const{ownerWindow:a}=r,s=t.style,o=a.getComputedStyle(e),c=pe(e,null,r),i=ye(o,c);return i.set("transition-property",["none",""]),i.delete("transition-property"),i.delete("all"),i.delete("d"),i.delete("content"),n&&(i.delete("margin-top"),i.delete("margin-right"),i.delete("margin-bottom"),i.delete("margin-left"),i.delete("margin-block-start"),i.delete("margin-block-end"),i.delete("margin-inline-start"),i.delete("margin-inline-end"),i.set("box-sizing",["border-box",""])),((u=i.get("background-clip"))==null?void 0:u[0])==="text"&&t.classList.add("______background-clip--text"),ae&&(i.has("font-kerning")||i.set("font-kerning",["normal",""]),(((l=i.get("overflow-x"))==null?void 0:l[0])==="hidden"||((f=i.get("overflow-y"))==null?void 0:f[0])==="hidden")&&((d=i.get("text-overflow"))==null?void 0:d[0])==="ellipsis"&&e.scrollWidth===e.clientWidth&&i.set("text-overflow",["clip",""])),i.forEach(([m,w],y)=>{s.setProperty(y,m,w)}),i}function Ct(e,t){return S(this,null,function*(){var s,o,c;const{ownerDocument:n,svgDefsElement:r}=t,a=(o=(s=e.querySelectorAll)==null?void 0:s.call(e,"use"))!=null?o:[];if(a.length)for(let i=a.length,u=0;u<i;u++){const l=a[u],f=(c=l.getAttribute("xlink:href"))!=null?c:l.getAttribute("href");if(!f)continue;const d=n==null?void 0:n.querySelector(`svg ${f}`);!d||r!=null&&r.querySelector(f)||r==null||r.appendChild(yield Y(d,t))}return e.cloneNode(!1)})}function Tt(e,t){var n;try{if((n=e==null?void 0:e.contentDocument)!=null&&n.body)return Y(e.contentDocument.body,t)}catch(r){v("Failed to clone iframe",r)}return e.cloneNode(!1)}function be(e){if(e.ownerDocument)try{const a=e.toDataURL();if(a!=="data:,")return P(a,e.ownerDocument)}catch(a){}const t=e.cloneNode(!1),n=e.getContext("2d"),r=t.getContext("2d");try{return n&&r&&r.putImageData(n.getImageData(0,0,e.width,e.height),0,0),t}catch(a){v("Failed to clone canvas",a)}return t}function vt(e){return S(this,null,function*(){if(e.ownerDocument&&!e.currentSrc&&e.poster)return P(e.poster,e.ownerDocument);const t=e.cloneNode(!1);t.crossOrigin="anonymous",e.currentSrc&&e.currentSrc!==e.src&&(t.src=e.currentSrc);const n=t.ownerDocument;if(n){let r=!0;if(yield _(t,{onError:()=>r=!1}),!r)return e.poster?P(e.poster,e.ownerDocument):t;t.currentTime=e.currentTime,yield new Promise(s=>{t.addEventListener("seeked",s,{once:!0})});const a=n.createElement("canvas");a.width=e.offsetWidth,a.height=e.offsetHeight;try{const s=a.getContext("2d");s&&s.drawImage(t,0,0,a.width,a.height)}catch(s){return v("Failed to clone video",s),e.poster?P(e.poster,e.ownerDocument):t}return be(a)}return t})}function At(e){const t=e.cloneNode(!1);return e.currentSrc&&e.currentSrc!==e.src&&(t.src=e.currentSrc,t.srcset=""),t.loading==="lazy"&&(t.loading="eager"),t}function Nt(e,t){return Je(e)?be(e):nt(e)?Tt(e,t):U(e)?At(e):z(e)?vt(e):Xe(e)?Ct(e,t):e.cloneNode(!1)}function Se(e,t,n){return S(this,null,function*(){I(t)&&(Qe(t)||Ze(t))||n.filter&&!n.filter(t)||e.appendChild(yield Y(t,n))})}function Ee(e,t,n){return S(this,null,function*(){var a,s;const r=(s=I(e)?(a=e.shadowRoot)==null?void 0:a.firstChild:void 0)!=null?s:e.firstChild;for(let o=r;o;o=o.nextSibling)if(!Ge(o))if(I(o)&&tt(o)&&typeof o.assignedNodes=="function"){const c=o.assignedNodes();for(let i=0;i<c.length;i++)yield Se(t,c[i],n)}else yield Se(t,o,n)})}function It(e,t){const{backgroundColor:n,width:r,height:a,style:s}=t,o=e.style;if(n&&o.setProperty("background-color",n),r&&o.setProperty("width",`${r}px`),a&&o.setProperty("height",`${a}px`),s)for(const c in s)o[c]=s[c]}function Y(e,t,n=!1){return S(this,null,function*(){var c,i,u;const{ownerDocument:r,ownerWindow:a,fontFamilies:s}=t;if(r&&Ye(e))return r.createTextNode(e.data);if(r&&a&&I(e)&&(te(e)||R(e))){const l=yield Nt(e,t);l.removeAttribute('"');const f=Et(e,l,n,t);n&&It(l,t);const d=[(c=f.get("overflow-x"))==null?void 0:c[0],(i=f.get("overflow-y"))==null?void 0:i[1]];return bt(e,l,d.includes("scroll")||(d.includes("auto")||d.includes("overlay"))&&(e.scrollHeight>e.clientHeight||e.scrollWidth>e.clientWidth),t),St(e,l),(u=f.get("font-family"))==null||u[0].split(",").filter(Boolean).map(m=>m.toLowerCase()).forEach(m=>s.add(m)),z(e)||(yield Ee(e,l,t)),l}const o=e.cloneNode(!1);return yield Ee(e,o,t),o})}function Ce(e){if(e.ownerDocument=void 0,e.ownerWindow=void 0,e.svgStyleElement=void 0,e.svgDefsElement=void 0,e.svgStyles.clear(),e.defaultComputedStyles.clear(),e.sandbox){try{e.sandbox.remove()}catch(t){}e.sandbox=void 0}e.workers=[],e.fontFamilies.clear(),e.fontCssTexts.clear(),e.requests.clear(),e.tasks=[]}function kt(e){const c=e,{url:t,timeout:n,responseType:r}=c,a=Be(c,["url","timeout","responseType"]),s=new AbortController,o=n?setTimeout(()=>s.abort(),n):void 0;return fetch(t,x({signal:s.signal},a)).then(i=>{if(!i.ok)throw new Error("Failed fetch, not 2xx response",{cause:i});switch(r){case"dataUrl":return i.blob().then(ct);case"text":default:return i.text()}}).finally(()=>clearTimeout(o))}function J(e,t){const{url:n,requestType:r="text",responseType:a="text",imageDom:s}=t;let o=n;const{timeout:c,acceptOfImage:i,requests:u,fetch:{requestInit:l,bypassingCache:f,placeholderImage:d},workers:m}=e;let w;if(u.has(n))w=u.get(n);else{f&&(o+=(/\?/.test(o)?"&":"?")+new Date().getTime()),r==="image"&&H&&e.drawImageCount++;const y=x({url:o,timeout:c,responseType:a,headers:r==="image"?{accept:i}:void 0},l);w={type:r,resovle:void 0,reject:void 0,response:null},w.response=(!H&&n.startsWith("http")&&m.length?new Promise((b,h)=>{m[u.size&m.length-1].postMessage(x({rawUrl:n},y)),w.resovle=b,w.reject=h}):kt(y)).catch(b=>{if(u.delete(n),r==="image"&&d)return v("Failed to fetch image base64, trying to use placeholder image",o),typeof d=="string"?d:d(s);throw b}),u.set(n,w)}return w.response}function Te(e,t,n,r){return S(this,null,function*(){if(!ve(e))return e;for(const[a,s]of xt(e,t))try{const o=yield J(n,{url:s,requestType:r?"image":"text",responseType:"dataUrl"});e=e.replace(Dt(a),`$1${o}$3`)}catch(o){v("Failed to fetch css data url",a,o)}return e})}function ve(e){return/url\((['"]?)([^'"]+?)\1\)/.test(e)}const Ae=/url\((['"]?)([^'"]+?)\1\)/g;function xt(e,t){const n=[];return e.replace(Ae,(r,a,s)=>(n.push([s,le(s,t)]),r)),n.filter(([r])=>!ne(r))}function Dt(e){const t=e.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1");return new RegExp(`(url\\(['"]?)(${t})(['"]?\\))`,"g")}function Ft(e,t){return S(this,null,function*(){const{ownerDocument:n,svgStyleElement:r,fontFamilies:a,fontCssTexts:s,tasks:o,font:c}=t;if(!(!n||!r||!a.size))if(c&&c.cssText){const i=Ie(c.cssText,t);r.appendChild(n.createTextNode(`${i}
`))}else{const i=Array.from(n.styleSheets).filter(l=>{try{return"cssRules"in l&&Boolean(l.cssRules.length)}catch(f){return v(`Error while reading CSS rules from ${l.href}`,f),!1}});yield Promise.all(i.flatMap(l=>Array.from(l.cssRules).map((f,d)=>S(this,null,function*(){if(ze(f)){let m=d+1;const w=f.href;let y="";try{y=yield J(t,{url:w,requestType:"text",responseType:"text"})}catch(h){v(`Error fetch remote css import from ${w}`,h)}const b=y.replace(Ae,(h,E,p)=>h.replace(p,le(p,w)));for(const h of Pt(b))try{l.insertRule(h,h.startsWith("@import")?m+=1:l.cssRules.length)}catch(E){v("Error inserting rule from remote css import",{rule:h,error:E})}}})))),i.flatMap(l=>Array.from(l.cssRules)).filter(l=>He(l)&&ve(l.style.getPropertyValue("src"))&&l.style.getPropertyValue("font-family").split(",").filter(Boolean).map(f=>f.toLowerCase()).some(f=>a.has(f))).forEach(l=>{const f=l,d=s.get(f.cssText);d?r.appendChild(n.createTextNode(`${d}
`)):o.push(Te(f.cssText,f.parentStyleSheet?f.parentStyleSheet.href:null,t).then(m=>{m=Ie(m,t),s.set(f.cssText,m),r.appendChild(n.createTextNode(`${m}
`))}))})}})}const Rt=/(\/\*[\s\S]*?\*\/)/gi,Ne=/((@.*?keyframes [\s\S]*?){([\s\S]*?}\s*?)})/gi;function Pt(e){if(e==null)return[];const t=[];let n=e.replace(Rt,"");for(;;){const s=Ne.exec(n);if(!s)break;t.push(s[0])}n=n.replace(Ne,"");const r=/@import[\s\S]*?url\([^)]*\)[\s\S]*?;/gi,a=new RegExp("((\\s*?(?:\\/\\*[\\s\\S]*?\\*\\/)?\\s*?@media[\\s\\S]*?){([\\s\\S]*?)}\\s*?})|(([\\s\\S]*?){([\\s\\S]*?)})","gi");for(;;){let s=r.exec(n);if(s)a.lastIndex=r.lastIndex;else if(s=a.exec(n),s)r.lastIndex=a.lastIndex;else break;t.push(s[0])}return t}const Ut=/url\([^)]+\)\s*format\((["']?)([^"']+)\1\)/g,_t=/src:\s*(?:url\([^)]+\)\s*format\([^)]+\)[,;]\s*)+/g;function Ie(e,t){const{font:n}=t,r=n?n==null?void 0:n.preferredFormat:void 0;return r?e.replace(_t,a=>{for(;;){const[s,,o]=Ut.exec(a)||[];if(!o)return"";if(o===r)return`src: ${s};`}}):e}function $t(e,t){if(U(e)){const n=e.currentSrc||e.src;if(!ne(n))return[J(t,{url:n,imageDom:e,requestType:"image",responseType:"dataUrl"}).then(r=>{r&&(e.srcset="",e.dataset.originalSrc=n,e.src=r||"")})];(H||se)&&n.includes("data:image/svg+xml")&&t.drawImageCount++}else if(R(e)&&!ne(e.href.baseVal)){const n=e.href.baseVal;return[J(t,{url:n,imageDom:e,requestType:"image",responseType:"dataUrl"}).then(r=>{r&&(e.dataset.originalSrc=n,e.href.baseVal=r||"")})]}return[]}const Bt=["background-image","border-image-source","-webkit-border-image","-webkit-mask-image","list-style-image"];function Lt(e,t){return Bt.map(n=>{const r=e.getPropertyValue(n);return r?((H||se)&&r.includes("data:image/svg+xml")&&t.drawImageCount++,Te(r,null,t,!0).then(a=>{!a||r===a||e.setProperty(n,a,e.getPropertyPriority(n))})):null}).filter(Boolean)}function ke(e,t){const{tasks:n}=t;I(e)&&(U(e)||ie(e))&&n.push(...$t(e,t)),te(e)&&n.push(...Lt(e.style,t)),e.childNodes.forEach(r=>{ke(r,t)})}function xe(e,t){return S(this,null,function*(){const n=yield k(e,t);if(I(n.node)&&R(n.node))return n.node;const{ownerDocument:r,log:a,tasks:s,svgStyleElement:o,svgDefsElement:c,svgStyles:i,font:u,progress:l,autoDestruct:f,onCloneNode:d,onEmbedNode:m,onCreateForeignObjectSvg:w}=n;a.time("clone node");const y=yield Y(n.node,n,!0);if(o&&r){let A="";i.forEach((B,L)=>{A+=`${B.join(`,
`)} {
  ${L}
}
`}),o.appendChild(r.createTextNode(A))}a.timeEnd("clone node"),d==null||d(y),u!==!1&&I(y)&&(a.time("embed web font"),yield Ft(y,n),a.timeEnd("embed web font")),a.time("embed node"),ke(y,n);const b=s.length;let h=0;const E=()=>S(this,null,function*(){for(;;){const A=s.pop();if(!A)break;try{yield A}catch(B){v("Failed to run task",B)}l==null||l(++h,b)}});l==null||l(h,b),yield Promise.all([...Array(4)].map(E)),a.timeEnd("embed node"),m==null||m(y);const p=Mt(y,n);return c&&p.insertBefore(c,p.children[0]),o&&p.insertBefore(o,p.children[0]),f&&Ce(n),w==null||w(p),p})}function Mt(e,t){const{width:n,height:r}=t,a=ue(n,r,e.ownerDocument),s=a.ownerDocument.createElementNS(a.namespaceURI,"foreignObject");return s.setAttributeNS(null,"x","0%"),s.setAttributeNS(null,"y","0%"),s.setAttributeNS(null,"width","100%"),s.setAttributeNS(null,"height","100%"),s.append(e),a.appendChild(s),a}function K(e,t){return S(this,null,function*(){var o;const n=yield k(e,t),r=yield xe(n),a=fe(r);n.autoDestruct||(n.svgStyleElement=we(n.ownerDocument),n.svgDefsElement=(o=n.ownerDocument)==null?void 0:o.createElementNS(G,"defs"),n.svgStyles.clear());const s=P(a,r.ownerDocument);return yield mt(s,n)})}function Ot(e,t){return S(this,null,function*(){const n=yield k(e,t),{log:r,type:a,quality:s,dpi:o}=n,c=yield K(n);r.time("canvas to blob");const i=yield st(c,a,s);if(["image/png","image/jpeg"].includes(a)&&o){const u=yield lt(i.slice(0,33));let l=new Uint8Array(u);return a==="image/png"?l=re(l,o):a==="image/jpeg"&&(l=C(l,o)),new Blob([l,i.slice(33)],{type:a})}return r.timeEnd("canvas to blob"),i})}function $(e,t){return S(this,null,function*(){const n=yield k(e,t),{log:r,quality:a,type:s,dpi:o}=n,c=yield K(n);r.time("canvas to data url");let i=c.toDataURL(s,a);if(["image/png","image/jpeg"].includes(s)&&o&&oe&&qe){const[u,l]=i.split(",");let f=0,d=!1;if(s==="image/png"){const p=We(l);p>=0?(f=Math.ceil((p+28)/3)*4,d=!0):f=33/3*4}else s==="image/jpeg"&&(f=18/3*4);const m=l.substring(0,f),w=l.substring(f),y=window.atob(m),b=new Uint8Array(y.length);for(let p=0;p<b.length;p++)b[p]=y.charCodeAt(p);const h=s==="image/png"?re(b,o,d):C(b,o),E=window.btoa(String.fromCharCode(...h));i=[u,",",E,w].join("")}return r.timeEnd("canvas to data url"),i})}function De(e,t){return S(this,null,function*(){const n=yield k(e,t),{width:r,height:a,ownerDocument:s}=n,o=yield $(n),c=ue(r,a,s),i=c.ownerDocument.createElementNS(c.namespaceURI,"image");return i.setAttributeNS(null,"href",o),i.setAttributeNS(null,"height","100%"),i.setAttributeNS(null,"width","100%"),c.appendChild(i),fe(c)})}function Wt(e,t){return S(this,null,function*(){const n=yield k(e,t),{ownerDocument:r,width:a,height:s,scale:o,type:c}=n,i=c==="image/svg+xml"?yield De(n):yield $(n),u=P(i,r);return u.width=Math.floor(a*o),u.height=Math.floor(s*o),u.style.width=`${a}px`,u.style.height=`${s}px`,u})}function jt(e,t){return S(this,null,function*(){return $(yield k(e,M(x({},t),{type:"image/jpeg"})))})}function qt(e,t){return S(this,null,function*(){const n=yield k(e,t),r=yield K(n);return r.getContext("2d").getImageData(0,0,r.width,r.height).data})}function Vt(e,t){return S(this,null,function*(){return $(yield k(e,M(x({},t),{type:"image/png"})))})}function Ht(e,t){return S(this,null,function*(){return $(yield k(e,M(x({},t),{type:"image/webp"})))})}g.createContext=he,g.destroyContext=Ce,g.domToBlob=Ot,g.domToCanvas=K,g.domToDataUrl=$,g.domToForeignObjectSvg=xe,g.domToImage=Wt,g.domToJpeg=jt,g.domToPixel=qt,g.domToPng=Vt,g.domToSvg=De,g.domToWebp=Ht,g.loadMedia=_,g.waitUntilLoad=me,Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});
